<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Preview Page</title>
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: white;
            font-size: 14px;
        }

        .preview-header {
            background-color: #342221;
            color: white;
            padding: 10px;
            font-weight: bold;
            width: 100%;
            border-radius: 5px;
            font-size: 14px;
        }

        .info-section {
            margin: 15px 0;
            font-size: 14px;
        }

        .info-label {
            font-weight: bold;
        }

        .query-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }

        .query-id {
            font-weight: bold;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 10px;
        }

        th,
        td {
            border: 1px solid #999;
            padding: 4px;
            text-align: center;
        }

        th {
            background-color: #555;
            color: white;
            text-align: center;
        }

        .button-row {
            margin-top: 20px;
            display: flex;
            justify-content: right;
        }

        .button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-btn {
            background-color: red;
            color: white;
        }

        .cancel-btn {
            background-color: #ddd;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-top: 15px;
        }

        img {
            width: 20px;
            height: 20px;
        }

        .button1 {
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 20px;
            border: 1px solid #ccc;
            padding: 5px;
        }

        .copy {
            margin-right: 20px;
            border-radius: 5px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            font-size: 14px;
        }

        .ck-editor__editable {
            min-height: 200px;
            font-size: 14px;
        }

        .subject {
            display: flex;
            justify-content: left;
            text-align: left;
            font-size: 14px;
            margin: 10px 0;
        }

        .subject strong {
            margin-right: 5px;
        }

        p {
            font-size: 14px;
            margin: 5px 0;
        }

        .subjects {
            text-align: left;
        }
    </style>
</head>

<body>
    <div class="notification" id="copyNotification">Copied to clipboard!</div>
    <div id="contentToCopy">
        <div class="preview-header">PREVIEW</div>

        <div class="info-section">
            <span class="info-label">Client:</span> John Doe &nbsp;&nbsp;
            <span class="info-label">Operation Person:</span> Jane Smith &nbsp;&nbsp;
            <span class="info-label">Sales Person:</span> Robert Brown &nbsp;&nbsp;
            <span class="info-label">Group:</span> Adventure Group
        </div>

        <div class="subject"><strong>Subject:</strong> Q12345 John Doe</div>
        <p>Destination:</p>

        <div class="query-box" id="contentToCopys">
            <div class="query-id">QueryId: <span id="queryId" style="color:#000; font-weight: bold;">Q12345</span></div>

            <div id="editor">
                <p>Dear John Doe,</p>
                <p>Thank you for your inquiry (Q12345). We are pleased to assist with your travel plans for 10
                    passengers (Business Type: Leisure).</p>
                <p>Please find the details below.</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th class="subjects">Subject</th>
                        <th>Adult</th>
                        <th>Child</th>
                        <th>Infant</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="subject" class="subjects">Q12345 John Doe</td>
                        <td id="adult">6</td>
                        <td id="child">3</td>
                        <td id="infant">1</td>
                    </tr>
                </tbody>
            </table>

            <div style="margin-top:15px;"><strong>Destinations</strong></div>
            <table>
                <thead>
                    <tr>
                        <th>S.N.</th>
                        <th>Date</th>
                        <th>Destination</th>
                    </tr>
                </thead>
                <tbody id="destinationsDataBody">
                    <tr>
                        <td>1</td>
                        <td>2025-08-01</td>
                        <td>Paris</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>2025-08-03</td>
                        <td>London</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="button-row">
        <button class="copy" id="copyButton">Copy</button>
        <button class="button1 send-btn" id="outlookButton"><img src="microsoft-outlook-icon.png"
                alt="microsoft-outlook-icon"></button>
        <button class="button send-btn" onclick="sendMail()">Send</button>
    </div>

    <script>
        let editor; // Global variable to store the CKEditor instance
        const contactEmail = "client@example.com"; // Static email address

        function showNotification() {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function copyToClipboard() {
            const contentToCopy = document.getElementById('contentToCopy');
            const range = document.createRange();
            range.selectNode(contentToCopy);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification();
                } else {
                    alert('Failed to copy content. Please try again.');
                }
            } catch (err) {
                alert('Error copying content: ' + err);
            }

            window.getSelection().removeAllRanges();
        }

        function openInOutlook() {
            if (!contactEmail) {
                alert("No email address found to send to!");
                return;
            }

            const clientName = "John Doe";
            const operationPerson = "Jane Smith";
            const salesPerson = "Robert Brown";
            const groupName = "Adventure Group";
            const subjectDisplay = "Q12345 John Doe";
            const queryId = "Q12345";
            const messageContent = editor ? editor.getData() : document.getElementById("editor").innerHTML;
            const adult = "6";
            const child = "3";
            const infant = "1";

            const destinationsText = `
        <li>2025-08-01 - Paris</li>
        <li>2025-08-03 - London</li>
      `;

            const htmlContent = `
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; }
            table { border-collapse: collapse; margin-bottom: 15px; }
            th, td { border: 1px solid #999; padding: 8px; text-align: center; }
            th { background-color: #555; color: white; }
            .header { font-weight: bold; margin-bottom: 5px; }
          </style>
        </head>
        <body>
          <div class="header">Client: ${clientName}</div>
          <div class="header">Operation Person: ${operationPerson}</div>
          <div class="header">Sales Person: ${salesPerson}</div>
          <div class="header">Group: ${groupName}</div>
          <div class="header">Query ID: ${queryId}</div>
          
          <hr>
          
          ${messageContent}
          
          <h3>Passenger Details</h3>
          <table>
            <tr>
              <th>Subject</th>
              <th>Adult</th>
              <th>Child</th>
              <th>Infant</th>
            </tr>
            <tr>
              <td>${queryId}</td>
              <td>${adult}</td>
              <td>${child}</td>
              <td>${infant}</td>
            </tr>
          </table>
          
          <h3>Destinations</h3>
          <ul>
            ${destinationsText}
          </ul>
        </body>
        </html>
      `;

            const subject = encodeURIComponent(queryId);
            const body = encodeURIComponent(htmlContent);
            const mailtoLink = `mailto:${contactEmail}?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Initialize CKEditor
            ClassicEditor
                .create(document.querySelector('#editor'))
                .then(instance => {
                    editor = instance;
                    editor.setData(`
            <p>Dear John Doe,</p>
            <p>Thank you for your inquiry (Q12345). We are pleased to assist with your travel plans for 10 passengers (Business Type: Leisure).</p>
            <p>Please find the details below.</p>
          `);
                })
                .catch(error => {
                    console.error(error);
                });

            // Add click event to copy button
            document.getElementById('copyButton').addEventListener('click', copyToClipboard);

            // Add click event to Outlook button
            document.getElementById('outlookButton').addEventListener('click', openInOutlook);
        });

        function sendMail() {
            const emailId = contactEmail;
            if (!emailId) {
                alert("No email address found to send to!");
                return;
            }

            const emailBody = editor ? editor.getData() : document.getElementById("editor").innerHTML;

            const payload = {
                ConfigId: "8",
                MailType: "3",
                To: emailId,
                Subject: "Q12345",
                Body: emailBody,
                Attachment: "s"
            };

            fetch("send-email", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(() => alert("Email sent successfully!"))
                .catch(error => {
                    console.error("Error sending email:", error);
                    alert("Failed to send email. Please try again.");
                });
        }
    </script>
</body>

</html>